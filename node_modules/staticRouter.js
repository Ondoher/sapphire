var mootools = require('./mootools').apply(GLOBAL);
var static = require('node-static');
var url = require('url');

var file = new(static.Server)('./public');

module.exports = function()
{
	return function(req, res, next)
	{
		if (req.done) return next();

		var paths = url.parse(req.url, true).pathname.split('/');
		paths.shift();
		if (paths[0] == 'assets')
		{
			file.serve(req, res);
			req.done = true;
		}
		else if (paths.indexOf('assets') != -1)
		{
			var path = paths.slice(2);
			var filepath = '../apps/' + paths.join('/');
			try
			{
				file.serveFile(filepath, 200, {}, req, res).on('error', function(e)
				{
					console.log(e.stack);
					next();
				});
			}
			catch (e) {}
			req.done = true;
		}
		else if (paths.indexOf('pages') != -1)
		{
			var path = paths.slice(2);
			var filepath = '../apps/' + paths.join('/');
			try
			{
				file.serveFile(filepath, 200, {}, req, res).on('error', function(e)
				{
					console.log(e.stack);
					next();
				});
			}
			catch (e) {}
			req.done = true;
		}
		else if (paths.indexOf('dialogs') != -1)
		{
			var path = paths.slice(2);
			var filepath = '../apps/' + paths.join('/');
			try
			{
				file.serveFile(filepath, 200, {}, req, res).on('error', function(e)
				{
					console.log(e.stack);
					next();
				});
			}
			catch (e) {}
			req.done = true;
		}
		else next();
	}
}
