var events = require('events');
var uuid = require('node-uuid');
var mootools = require('./mootools').apply(GLOBAL);
var Cookies = require('cookies');
var crypto = require('crypto');
var sessions = require('sessions');

var SessionRouter = new Class(
{
	initialize : function(req, res)
	{
		this.sessionId = req.cookies.get('sessionId');
	// if it is not in the cookies, try the headers

		if (!this.sessionId)
		{
			if (req.headers['x-sapphire-session'] !== undefined)
				this.sessionId = req.headers['x-sapphire-session'];
		}

		this.req = req;
		this.res = res;
		this.cookieSent = false;

		res.on('finish', this.onResponseDone.bind(this));
		this.session = new sessions.Session(this.sessionId);
	},

	setSessionId : function()
	{
		this.res.cookies.set('sessionId', this.session.getSessionId(), {httpOnly: false});
		this.res.setHeader('X-Sapphire-Session', this.session.getSessionId());
	},

	get : function()
	{
		return this.session.get();
	},

	set : function(name, value)
	{
		this.session.set(name, value);

		if (!this.cookieSent) this.setSessionId();

		this.cookieSent = true;

	},

	onResponseDone : function()
	{
		this.session.save();
	}
});

SessionRouter.implement(events.EventEmitter.prototype);


var SessionWrapper = new Class({
	initialize: function(data, router)
	{
		this.data = data;
		this.router = router;
	},

	get : function()
	{
		return this.data;
	},

	set : function(name, value)
	{
		this.router.set(name, value);
	}
});

module.exports = function()
{

	return function(req, res, next)
	{
		var router = new SessionRouter(req, res);
		router.get()
			.then(function(session)
			{
				req.session = new SessionWrapper(session, router);
				next();
			});
	}
}
