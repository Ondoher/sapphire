/*
Middleware: appRouter

If the url points to an application, it will run that application.
*/
var mootools = require('./mootools').apply(GLOBAL);
var url = require('url');
var fs = require('fs');
var uuid = require('node-uuid');
var Q = require('q');
var CONFIG = require('config').CONFIG;
var path = require('path');

var apps = $H({});

function getApp(root, path, callback)
{
	var file = path.split('/').pop();
	var file = root + path + '/' + file + '.js';
	if (apps.has(path))
	{
		return callback(apps[path], file);
	}
	else
	{
		fs.exists(file, function(exists)
		{
	  		if (exists)
			{
				if (root.charAt(0) != '/') file = '../' + file;

				apps[path] = require(file);
				return callback(apps[path], file);
			}
			else
				callback(null, '');
		});
	}
}

module.exports = function()
{
	return function(req, res, next)
	{
		if (req.error) return next();
		var appPath = req.appPath;
		var ext = path.extname(req.url);
		var javascript = ext == '.js';
		var css = ext == '.css';

		if (javascript) appPath.replace(/\.js/g, '');
		if (css) appPath.replace(/\.css/g, '');

		if (appPath == null) return next();

		getApp(CONFIG.basePath + 'apps/', appPath, function(app, appPath)
		{
			if (app)
			{
				app.getApplication(req, res)
					.then(function(app)
					{
						if (javascript)
						{
							app.getJavaScript(function(content)
							{
								res.writeHead(200, {'Content-Type': 'text/javascript'});
								res.end(content);
								req.done = true;
							});
						}
						else if (css)
						{
							app.getCss(function(content)
							{
								res.writeHead(200, {'Content-Type': 'text/css'});
								res.end(content);
								req.done = true;
							});
						}
						else
						{
							app.getHTML(function(content)
							{
								res.cookies.set('sapphire-xss', uuid.v4(), {httpOnly: false});
								res.writeHead(200, {'Content-Type': 'text/html'});
								res.end(content);
								req.done = true;
							});
						}
					}).done();
			}
			else next();
		});
	}
}
